# 此文件为修正版，移除了所有导致错误的不可见特殊字符
# 并修正了 OCaml 的版本

name: Build All Tools

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-alice-tools:
    name: Build alice-tools
    runs-on: ubuntu-latest
    strategy:
      matrix:
        buildtype: [debug, release]
        
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装依赖
        run: |
          sudo apt-get update
          # 修正：移除了所有行尾的不可见字符
          sudo apt-get install -y \
            bison \
            flex \
            meson \
            ninja-build \
            libpng-dev \
            libturbojpeg0-dev \
            libwebp-dev \
            zlib1g-dev

      - name: 配置 meson
        run: |
          cd alice-tools
          meson setup build --buildtype=${{ matrix.buildtype }}

      - name: 使用 ninja 构建
        run: |
          cd alice-tools
          ninja -C build

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: alice-tools-${{ matrix.buildtype }}
          path: alice-tools/build/src/alice

  build-sys4lang:
    name: Build sys4lang
    runs-on: ubuntu-latest
      
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 OCaml
        uses: ocaml/setup-ocaml@v2
        with:
          # 修正：将 OCaml 版本 4.14.x 更改为 5.2.x
          # 以匹配 sys4lang.opam 文件中 "ocaml {>= "5.2"}" 的要求
          ocaml-compiler: '5.2.x'

      - name: 安装依赖
        run: |
          cd sys4lang
          opam install . --deps-only --with-test

      - name: 构建 sys4lang (debug)
        run: |
          cd sys4lang
          dune build

      - name: 构建 sys4lang (release)
        run: |
          cd sys4lang
          dune build --profile release

      - name: 上传 debug 产物
        uses: actions/upload-artifact@v4
        with:
          name: sys4lang-debug
          path: |
            sys4lang/_build/default/bin/sys4c.exe
            sys4lang/_build/default/bin/sys4dc.exe
            sys4lang/_build/default/bin/sys4lsp.exe

      - name: 上传 release 产物
        uses: actions/upload-artifact@v4
        with:
          name: sys4lang-release
          path: |
            sys4lang/_build/release/bin/sys4c.exe
            sys4lang/_build/release/bin/sys4dc.exe
            sys4lang/_build/release/bin/sys4lsp.exe

  build-aindecompiler:
    name: Build AinDecompiler
    runs-on: windows-latest
    strategy:
      matrix:
        configuration: [Debug, Release]
        
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: 还原 NuGet 包
        run: |
          cd "AinDecompiler/Source Code/AinDecompiler"
          nuget restore AinDecompiler.csproj -PackagesDirectory ../packages

      - name: 构建 AinDecompiler
        run: |
          cd "AinDecompiler/Source Code/AinDecompiler"
          msbuild AinDecompiler.csproj /p:Configuration=${{ matrix.configuration }} /p:Platform=x86

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: AinDecompiler-${{ matrix.configuration }}
          path: |
            AinDecompiler/Source Code/AinDecompiler/bin/x86/${{ matrix.configuration }}/
